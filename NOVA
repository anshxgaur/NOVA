import os
import subprocess
import webbrowser
import requests
import pyttsx3
import speech_recognition as sr
import pywhatkit as pkit
import psutil
import pyautogui
import pygetwindow as gw
from datetime import datetime
from ctypes import POINTER, cast
from pynput.keyboard import Controller

# Optional modules
try:
    from comtypes import CLSCTX_ALL
    from pycaw.pycaw import AudioUtilities, IAudioEndpointVolume
    HAS_PYCAW = True
except:
    HAS_PYCAW = False

try:
    import screen_brightness_control as sbc
    HAS_BRIGHTNESS = True
except:
    HAS_BRIGHTNESS = False

# Initialization

engine = pyttsx3.init()
engine.setProperty('rate', 150) b 
keyboard = Controller()

volume_iface = None
if HAS_PYCAW:
    try:
        devices = AudioUtilities.GetSpeakers()
        iface = devices.Activate(IAudioEndpointVolume._iid_, CLSCTX_ALL, None)
        volume_iface = cast(iface, POINTER(IAudioEndpointVolume))
    except:
        volume_iface = None


def speak(text):
    print(f"[Nova] {text}")
    try:
        engine.say(text)
        engine.runAndWait()
    except Exception as e:
        print("[Speak error]", e)

def speechrecognition():
    r = sr.Recognizer()
    with sr.Microphone() as source:
        print("Listening...")
        r.pause_threshold = 1
        try:
            audio = r.listen(source, timeout=8)
            query = r.recognize_google(audio).lower()
            return query
        except:
            return ""

def get_weather(city):
    api_key = "YOUR_API_KEY"  # Replace with your OpenWeatherMap API key
    url = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}&units=metric"
    response = requests.get(url)
    data = response.json()
    if data["cod"] != "404":
        temp = data["main"]["temp"]
        desc = data["weather"][0]["description"]
        return f"The temperature in {city} is {temp}Â°C with {desc}."
    else:
        return "City not found."

def play_youtube_video(query):
    if query:
        try:
            pkit.playonyt(query)
            speak(f"Playing {query} on YouTube")
        except:
            speak("Couldn't play that. Opening YouTube search.")
            webbrowser.open("https://www.youtube.com/results?search_query=" + query.replace(" ", "+"))

def close_youtube():
    closed = False
    for p in psutil.process_iter():
        try:
            if any(b in p.name().lower() for b in ["chrome", "msedge", "brave", "firefox"]):
                p.kill()
                closed = True
        except:
            pass
    speak("YouTube has been closed." if closed else "YouTube is not open.")

def increase_volume():
    if volume_iface:
        curr = volume_iface.GetMasterVolumeLevelScalar()
        new = min(curr + 0.1, 1.0)
        volume_iface.SetMasterVolumeLevelScalar(new, None)
        speak(f"Volume increased to {int(new * 100)} percent.")
    else:
        speak("Volume control not available.")

def decrease_volume():
    if volume_iface:
        curr = volume_iface.GetMasterVolumeLevelScalar()
        new = max(curr - 0.1, 0.0)
        volume_iface.SetMasterVolumeLevelScalar(new, None)
        speak(f"Volume decreased to {int(new * 100)} percent.")
    else:
        speak("Volume control not available.")

def increase_brightness():
    if HAS_BRIGHTNESS:
        curr = sbc.get_brightness()[0]
        new = min(curr + 10, 100)
        sbc.set_brightness(new)
        speak(f"Brightness increased to {new} percent.")
    else:
        speak("Brightness control not available.")

def decrease_brightness():
    if HAS_BRIGHTNESS:
        curr = sbc.get_brightness()[0]
        new = max(curr - 10, 0)
        sbc.set_brightness(new)
        speak(f"Brightness decreased to {new} percent.")
    else:
        speak("Brightness control not available.")

def move_mouse_to_coordinates():
    speak("Say the X coordinate.")
    try:
        x = int(speechrecognition())
        speak("Say the Y coordinate.")
        y = int(speechrecognition())
    except:
        speak("Invalid coordinates.")
        return
    width, height = pyautogui.size()
    if 0 <= x < width and 0 <= y < height:
        pyautogui.moveTo(x, y)
        speak(f"Mouse moved to {x}, {y}.")
    else:
        speak("Coordinates out of bounds.")

def minimize_all_windows():
    for w in gw.getAllWindows():
        if hasattr(w, "minimize"):
            w.minimize()

def maximize_window():
    w = gw.getActiveWindow()
    if w:
        w.maximize()


def MainExecution(query: str):
    query = query.lower().strip()

    commands = {
        "hello": lambda: speak("Hello Ansh, I am Nova. How may I assist you?"),
        "bye": lambda: speak("Have a nice day!"),
        "capital of india": lambda: speak("The capital of India is Delhi."),
        "capital of uttar pradesh": lambda: speak("The capital of Uttar Pradesh is Lucknow."),
        "time": lambda: speak(f"The current time is {datetime.now().strftime('%H:%M')}"),
        "open youtube": lambda: (speak("Opening YouTube"), webbrowser.open("https://www.youtube.com")),
        "close youtube": close_youtube,
        "open google": lambda: (speak("Opening Google"), webbrowser.open("https://www.google.com")),
        "weather of kanpur": lambda: speak(get_weather("Kanpur")),
        "play youtube": lambda: (
            speak("Tell me the name of the video or song you would like to play"),
            play_youtube_video(speechrecognition())
        ),
        "increase volume": increase_volume,
        "decrease volume": decrease_volume,
        "increase brightness": increase_brightness,
        "decrease brightness": decrease_brightness,
        "move mouse": move_mouse_to_coordinates,
        "minimize all windows": minimize_all_windows,
        "maximize window": maximize_window,
    }

    for key, action in commands.items():
        if key in query:
            action()
            return

    speak("I didn't understand that.")

if __name__ == "__main__":
    user_query = speechrecognition()
    MainExecution(user_query)
